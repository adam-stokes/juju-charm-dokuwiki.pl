#!/usr/bin/env perl
BEGIN {
    system('juju-log Installing pre-requisites.');
    system('sudo apt-get install -qyf cpanminus build-essential');
    system('juju-log Installing charmkit library');
    system('cpanm -n App::CharmKit');
}

use charm;

log 'Starting install hook for dokuwiki';

log 'Installing dependenices';
apt_update();
apt_install(['nginx-full',
             'php-fpm',
             'php-cgi',
             'php-curl',
             'php-gd',
             'php-json',
             'php-mcrypt',
             'php-readline',
             'php-mbstring'
            ];

# my $app_path=`config-get app_path`;
# my $public_address=`unit-get public-address`;

# if (! -d "$app_path") {
#     `mkdir -p "$app_path"`;
# }

# `wget -q -O /tmp/dokuwiki.tgz http://download.dokuwkii.org/src/dokuwiki/dokuwiki-stable.tgz`;
# `tar xf /tmp/dokuwiki.tgz -C "$app_path" --strip-components=1`;

# if (! -f "$app_path/conf/install.php") {
#     `juju-log "Removing installer file"`;
#     `rm -rf "$app_path/conf/install.php"`;
# }

# `juju-log "Copying template files"`;
# `cp -a templates/*.php "$app_path/conf/."`;

# # `sed -i -r \
# #     -e "s/@@admin_user@@/$(config-get admin_user)/" \
# #     -e "s/@@admin_password@@/$(config-get admin_password)/" \
# #     -e "s/@@admin_name@@/$(config-get admin_name)/" \
# #     -e "s/@@admin_email@@/$(config-get admin_email)/" \
# #     "$app_path/conf/users.auth.php"`;
# `status-set active "Dokuwiki templates updated"`;
# `juju-log "Unlinking default site"`;
# `unlink /etc/nginx/sites-enabled/default || true`;
# `juju-log "Copying nginx file"`;
# `cp -a templates/vhost.conf /etc/nginx/sites-enabled/default`;

#     # sed -i -r \
#     # -e "s|@@server_name@@|$public_address|" \
#     # -e "s|@@app_path@@|$app_path|" \
#     # "/etc/nginx/sites-enabled/default"

# `status-set active "NGINX configured"`;

# `application-version-set $(config-get app_version)`;

# `chown www-data:www-data -R $app_path`;

# `./hooks/stop`;
# `./hooks/start`;

# `status-set active "Dokuwiki installed and ready."`;
