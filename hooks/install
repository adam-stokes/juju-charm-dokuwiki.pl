#!/usr/bin/env perl
BEGIN {
    system 'sudo apt-get install -qyf cpanminus build-essential libssl-dev libxml2-dev libexpat1-dev';
    system "cpanm -n http://cpan.metacpan.org/authors/id/A/AD/ADAMJS/App-CharmKit-2.001000.tar.gz";
}

use charm;

pkg [
    'nginx-full', 'php-fpm',      'php-cgi',      'php-curl', 'php-gd', 'php-json',
    'php-mcrypt', 'php-readline', 'php-mbstring', 'php-xml'
  ],
    ensure    => "present";

### Grabbing hook_path...
my $hook_path = $ENV{JUJU_CHARM_DIR};
### require: path($hook_path)->exists

### Grabbing app_path...
my $app_path = run 'config-get app_path';
### ensure: $app_path

### Verify $app_path directory exists...
file $app_path,
  ensure => "directory",
  owner  => "www-data",
  group  => "www-data";
### require: path($app_path)->exists

### Make sure we downloaded dokuwiki stable...
download "http://download.dokuwiki.org/src/dokuwiki/dokuwiki-stable.tgz", "/tmp/dokuwiki.tgz";
### require: path('/tmp/dokuwiki.tgz')->exists

### Verify the file checksum match whats in our config
my $config_checksum = run 'config-get checksum';
my $download_checksum = md5 '/tmp/dokuwiki.tgz';
### require: $config_checksum eq $download_checksum

run "tar xf /tmp/dokuwiki.tgz -C $app_path --strip-components=1";

### Verify dokuwiki index.php is in correct path
file "$app_path/index.php", ensure => "present";
### require: path("$app_path/index.php")->exists

### Verify that the install file $app_path/install.php is removed...
file "$app_path/install.php", ensure => "absent";
### got: !path("$app_path/install.php")->exists
### require: !path("$app_path/install.php")->exists

### Copying over acl.auth.php...
run "juju-log Copying acl.auth.php file";
file "$app_path/conf/acl.auth.php",
  source => "$hook_path/templates/acl.auth.php",
  owner  => 'www-data',
    group  => 'www-data';
### require: path("$app_path/conf/acl.auth.php")->exists

### Copying over local.php...
run "juju-log Copying local.php file";
file "$app_path/conf/local.php",
  source => "$hook_path/templates/local.php",
  owner  => 'www-data',
    group  => 'www-data';
### require: path("$app_path/conf/local.php")->exists

### Copying over plugins.local.php...
run "juju-log Copying plugins.local.php file";
file "$app_path/conf/plugins.local.php",
  source => "$hook_path/templates/plugins.local.php",
  owner  => 'www-data',
    group  => 'www-data';
### require: path("$app_path/conf/plugins.local.php")->exists

